<navbar title="负债详情"></navbar>
<view class="page">
  <view wx:if="{{loading}}" class="loading-container">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
  <view wx:elif="{{error}}" class="error-state">
    <text class="error-text">{{error}}</text>
  </view>
  <view wx:else>
    <view class="card hero-card">
      <view class="card-header">
        <view class="item-icon asset-item-icon">
          <image class="icon-image" src="/assets/icons/{{icon}}" mode="aspectFit"></image>
        </view>
        <view class="header-info">
          <text class="asset-name">{{detail.name}}</text>
          <view class="tags">
            <text class="tag">负债</text>
            <text class="tag">{{detail.category}}</text>
          </view>
        </view>
        <image class="action-icon" src="/assets/icons/edit-line.svg" mode="aspectFit" bindtap="openEditMenu"></image>
      </view>
      <view class="value-row">
        <text class="value-label">负债现值</text>
        <view class="value">
          <text class="currency">￥</text>
          <text class="amount">{{detail.current_value_display}}</text>
        </view>
      </view>
      <view class="metrics">
        <view class="metric">
          <text class="metric-label">期初金额</text>
          <text class="metric-value">￥{{detail.initial_amount_display}}</text>
        </view>
        <view class="metric">
          <text class="metric-label">变化</text>
          <text class="metric-value {{change_positive ? 'positive' : (change_negative ? 'negative' : '')}}">{{change_sign}}{{detail.change_display}}</text>
        </view>
        <view class="metric">
          <text class="metric-label">最近更新</text>
          <text class="metric-value">{{detail.updated_at_display}}</text>
        </view>
      </view>
    </view>
    <view class="card">
      <view class="card-header">
        <text class="card-title">现值趋势</text>
      </view>
      <view class="chart-block">
        <canvas type="2d" id="valueTrendCanvas" canvas-id="valueTrendChart" class="chart-canvas" style="width: 100%; height: 160px;"></canvas>
      </view>
    </view>
    <view class="card info-card">
      <view class="card-header">
        <text class="card-title">基本信息</text>
      </view>
      <view class="info-list">
        <view class="info-item"><text class="info-label">币种</text><text class="info-value">{{detail.currency}}</text></view>
        <view class="info-item"><text class="info-label">创建时间</text><text class="info-value">{{detail.created_at_display}}</text></view>
        <view class="info-item" wx:if="{{detail.next_due_date_display}}"><text class="info-label">到期日</text><text class="info-value">{{detail.next_due_date_display}}</text></view>
      </view>
    </view>

    <view class="card schedule-card" wx:if="{{detail.monthly_payment || detail.loan_term_months || detail.loan_start_date}}">
      <view class="card-header">
        <text class="card-title">还款计划</text>
      </view>
      <view class="info-list">
        <view class="info-item" wx:if="{{detail.monthly_payment}}"><text class="info-label">月供</text><text class="info-value">￥{{detail.monthly_payment_display}}</text></view>
        <view class="info-item" wx:if="{{detail.loan_term_months}}"><text class="info-label">期限</text><text class="info-value">{{detail.loan_term_months}} 个月</text></view>
        <view class="info-item" wx:if="{{detail.loan_start_date_display}}"><text class="info-label">开始日期</text><text class="info-value">{{detail.loan_start_date_display}}</text></view>
        <view class="info-item" wx:if="{{detail.loan_end_date_display}}"><text class="info-label">结束日期</text><text class="info-value">{{detail.loan_end_date_display}}</text></view>
        <view class="info-item" wx:if="{{detail.annual_interest_rate_display}}"><text class="info-label">年利率</text><text class="info-value">{{detail.annual_interest_rate_display}}%</text></view>
      </view>
    </view>



    <view class="card note-card" wx:if="{{detail.note}}">
      <view class="card-header"><text class="card-title">备注</text></view>
      <view class="note-content">{{detail.note}}</view>
    </view>
    <view class="card list-card">
      <view class="card-header">
        <text class="card-title">更新现值记录</text>
        <text class="card-count" wx:if="{{valueUpdates.length > 0}}">{{valueUpdates.length}} 条</text>
      </view>
      <view class="list-container" wx:if="{{valueUpdates.length > 0}}">
        <view class="list-item" wx:for="{{valueUpdates}}" wx:key="date_display" data-id="{{item.id}}" data-ts="{{item.raw_ts}}">
          <view class="item-content">
            <view class="item-name">现值更新</view>
            <view class="item-meta">
              <text class="item-category">￥{{item.value_display}}</text>
              <text class="item-date">{{item.date_display}}</text>
            </view>
          </view>
          <view class="item-actions">
            <image class="action-icon" src="/assets/icons/edit-line.svg" mode="aspectFit" bindtap="editValueUpdate" data-id="{{item.id}}" data-ts="{{item.raw_ts}}"></image>
            <image class="action-icon" src="/assets/icons/delete-bin-line.svg" mode="aspectFit" bindtap="deleteValueUpdate" data-id="{{item.id}}" data-ts="{{item.raw_ts}}"></image>
          </view>
        </view>
      </view>
      <view class="empty-state" wx:else>
        <view class="empty-text">暂无更新记录</view>
      </view>
    </view>

    <view class="footer-actions">
      <button class="primary-btn" bindtap="openUpdateModal">更新现值</button>
    </view>

    <view class="update-modal" wx:if="{{showUpdateModal}}">
      <view class="modal-mask" bindtap="closeUpdateModal"></view>
      <view class="modal-body">
        <text class="modal-title">更新现值</text>
        <view class="modal-input" data-key="updateValueInput" data-title="现值金额" bindtap="openNKeyboard">
          <text>{{updateValueInput || '请输入现值金额'}}</text>
        </view>
        <view class="modal-row">
          <text class="modal-label">记录日期</text>
          <picker mode="date" value="{{updateDateInput}}" bindchange="handleUpdateDateChange">
            <view class="picker-display">{{updateDateInput}}</view>
          </picker>
        </view>
        <view class="modal-row">
          <text class="modal-label">记录时间</text>
          <picker mode="time" value="{{updateTimeInput}}" bindchange="handleUpdateTimeChange">
            <view class="picker-display">{{updateTimeInput}}</view>
          </picker>
        </view>
        <view class="modal-actions">
          <button class="btn cancel" bindtap="closeUpdateModal">取消</button>
          <button class="btn confirm" loading="{{savingUpdate}}" bindtap="saveUpdateValue">保存</button>
        </view>
      </view>
    </view>

    <numeric-keyboard visible="{{nKeyboardVisible}}" value="{{nKeyboardValue}}" maxLength="{{nKeyboardMaxLength}}" maxDecimals="{{nKeyboardMaxDecimals}}" title="{{nKeyboardTitle}}" theme="expense" saveDisabled="{{savingUpdate}}" bind:input="onNKeyboardInput" bind:confirm="onNKeyboardConfirm" bind:save="onNKeyboardSave" bind:close="onNKeyboardClose" />

  </view>
</view>
