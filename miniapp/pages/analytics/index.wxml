<navbar title="数据分析" showBack="{{false}}"></navbar>
<view class="page">
  <view wx:if="{{needLogin}}" class="login-state">
    <text class="login-title">登录后查看数据分析</text>
    <button class="login-btn" bindtap="handleLogin" loading="{{loggingIn}}">微信登录</button>
  </view>
  <view wx:elif="{{loading}}" class="loading-state">
    <view class="loading-spinner"></view>
    <text class="loading-text">分析中...</text>
  </view>

  <view wx:elif="{{error}}" class="error-state">
    <text class="error-text">{{error}}</text>
    <button class="retry-btn" bindtap="fetchAnalytics">重试</button>
  </view>

  <scroll-view wx:else scroll-y="true" class="content" enable-back-to-top="true">
    <view class="hero-card">
      <view class="hero-row">
        <view class="hero-metric">
          <text class="metric-label">净资产</text>
          <text class="metric-value">￥{{summary.netWorth}}</text>
        </view>
        <view class="hero-change {{summary.changeRatioValue >= 0 ? 'positive' : 'negative'}}">
          <text class="change-value">{{summary.netChange}}</text>
          <text class="change-ratio">{{summary.changeRatio}}</text>
          <text class="change-label">区间变化</text>
        </view>
      </view>
      <view class="hero-grid">
        <view class="hero-stat">
          <view class="stat-icon positive">
            <image class="stat-icon-img" src="/assets/icons/wallet-3-line.svg" mode="aspectFit"></image>
          </view>
          <text class="stat-label">总资产</text>
          <text class="stat-value positive">￥{{summary.totalAssets}}</text>
        </view>
        <view class="hero-divider"></view>
        <view class="hero-stat">
          <view class="stat-icon negative">
            <image class="stat-icon-img" src="/assets/icons/bill-line-red.svg" mode="aspectFit"></image>
          </view>
          <text class="stat-label">总负债</text>
          <text class="stat-value negative">￥{{summary.totalLiabilities}}</text>
        </view>
        <view class="hero-divider"></view>
        <view class="hero-stat">
          <view class="stat-icon">
            <image class="stat-icon-img" src="/assets/icons/scales-line.svg" mode="aspectFit"></image>
          </view>
          <text class="stat-label">资产负债率</text>
          <text class="stat-value">{{summary.debtRatio}}</text>
        </view>
      </view>
    </view>

    <view class="card health-card">
      <view class="card-header">
        <text class="card-title">财务体检</text>
        <text class="card-subtitle">Financial Health</text>
      </view>
      <view class="health-grid">
        <view class="health-item" wx:for="{{healthMetrics}}" wx:key="name">
          <view class="health-top">
            <text class="health-name">{{item.name}}</text>
            <view class="health-tag {{item.status}}">{{item.statusLabel}}</view>
          </view>
          <view class="health-val">{{item.value}}</view>
          <view class="health-desc">{{item.desc}}</view>
          <view class="health-progress-bg">
            <view class="health-progress-bar" style="width: {{item.percent}}%; background-color: {{item.color}};"></view>
          </view>
          <view class="health-std">目标: {{item.standard}}</view>
        </view>
      </view>
    </view>

    <view class="card monthly-card" bindtap="clearMonthlySelection">
      <view class="card-header">
        <text class="card-title">资产走势</text>
        <text class="card-subtitle">Asset Trend</text>
      </view>
      <view class="chart-legend legend-inline">
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #10b981;"></view>
          <text class="legend-text">总资产</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #ef4444;"></view>
          <text class="legend-text">总负债</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #6366f1;"></view>
          <text class="legend-text">净资产</text>
        </view>
      </view>
      <view class="chart-block">
        <canvas type="2d" id="monthlyValueCanvas" canvas-id="monthlyValueChart" class="chart-canvas" catchtap="noop" bindtouchstart="onMonthlyValueTouch" bindtouchmove="onMonthlyValueTouch"></canvas>
      </view>
      <view class="chart-legend">
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #8b5cf6;"></view>
          <text class="legend-text">负债率</text>
        </view>
      </view>
      <view class="chart-block">
        <canvas type="2d" id="monthlyRatioCanvas" canvas-id="monthlyRatioChart" class="chart-canvas" catchtap="noop" bindtouchstart="onMonthlyRatioTouch" bindtouchmove="onMonthlyRatioTouch"></canvas>
      </view>
    </view>

    <view class="card">
      <view class="card-header">
        <text class="card-title">预计收入分布</text>
        <text class="card-subtitle">Income Distribution</text>
      </view>
      <view class="chart-wrapper">
        <canvas type="2d" id="incomePie" canvas-id="incomePie" class="chart-canvas" bindtouchstart="onIncomePieTouch" bindtouchmove="onIncomePieTouch"></canvas>
      </view>
      <view class="chart-legend">
        <block wx:for="{{incomeChartData}}" wx:key="index">
          <view class="legend-item">
            <view class="legend-dot" style="background-color: {{item.color}}"></view>
            <text class="legend-name">{{item.name}}</text>
            <text class="legend-percent">{{item.percentage}}%</text>
          </view>
        </block>
      </view>
      <view class="card-header">
        <text class="card-title">固定收支趋势</text>
        <text class="card-subtitle">Income Trend</text>
      </view>
      <view class="chart-legend legend-inline">
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #22c55e;"></view>
          <text class="legend-text">收入</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #ef4444;"></view>
          <text class="legend-text">支出</text>
        </view>
        <view class="legend-item">
          <view class="legend-dot" style="background-color: #6366f1;"></view>
          <text class="legend-text">净收入</text>
        </view>
      </view>
      <view class="chart-block">
        <canvas type="2d" id="incomeTrendCanvas" canvas-id="incomeTrendCanvas" class="chart-canvas" catchtap="noop" bindtouchstart="onIncomeTrendTouch" bindtouchmove="onIncomeTrendTouch"></canvas>
      </view>
      <view class="card-header card-header--spaced">
        <text class="card-title">收支比趋势</text>
        <text class="card-subtitle">Income/Expense Ratio</text>
      </view>
      <view class="chart-block">
        <canvas type="2d" id="incomeExpenseRatioCanvas" canvas-id="incomeExpenseRatioCanvas" class="chart-canvas" catchtap="noop" bindtouchstart="onIncomeExpenseRatioTouch" bindtouchmove="onIncomeExpenseRatioTouch"></canvas>
      </view>
      <view class="card-header card-header--spaced">
        <text class="card-title">固定支出分布</text>
        <text class="card-subtitle">Expense Distribution</text>
      </view>
      <view class="chart-wrapper">
        <canvas type="2d" id="expensePie" canvas-id="expensePie" class="chart-canvas" bindtouchstart="onExpensePieTouch" bindtouchmove="onExpensePieTouch"></canvas>
      </view>
      <view class="chart-legend">
        <block wx:for="{{expenseChartData}}" wx:key="index">
          <view class="legend-item">
            <view class="legend-dot" style="background-color: {{item.color}}"></view>
            <text class="legend-name">{{item.name}}</text>
            <text class="legend-percent">{{item.percentage}}%</text>
          </view>
        </block>
      </view>
    </view>

    

    <view class="card category-card">
      <view class="card-header">
        <text class="card-title">资产/负债对比</text>
        <text class="card-subtitle">Category Breakdown</text>
      </view>
      <view class="category-columns">
        <view class="category-column">
          <view class="column-title">资产分类</view>
          <view wx:if="{{assetCategories.length === 0}}" class="empty-line">暂无数据</view>
          <block wx:for="{{assetCategories}}" wx:key="category">
            <view class="category-item" bindtap="openCategoryDetail" data-type="asset" data-category="{{item.category}}">
              <view class="category-row">
                <view class="category-icon">
                  <image class="category-icon-img" src="/assets/icons/{{item.icon}}" mode="aspectFit"></image>
                </view>
                <text class="category-name">{{item.category}}</text>
                <text class="category-amount">{{item.amountText}}</text>
              </view>
              <view class="progress">
                <view class="progress-fill asset" style="width: {{item.percentage}}%;"></view>
              </view>
              <text class="category-percentage">{{item.percentageText}}</text>
            </view>
          </block>
        </view>
        <view class="category-divider"></view>
        <view class="category-column">
          <view class="column-title">负债分类</view>
          <view wx:if="{{liabilityCategories.length === 0}}" class="empty-line">暂无数据</view>
          <block wx:for="{{liabilityCategories}}" wx:key="category">
            <view class="category-item" bindtap="openCategoryDetail" data-type="liability" data-category="{{item.category}}">
              <view class="category-row">
                <view class="category-icon">
                  <image class="category-icon-img" src="/assets/icons/{{item.icon}}" mode="aspectFit"></image>
                </view>
                <text class="category-name">{{item.category}}</text>
                <text class="category-amount">{{item.amountText}}</text>
              </view>
              <view class="progress">
                <view class="progress-fill liability" style="width: {{item.percentage}}%;"></view>
              </view>
              <text class="category-percentage">{{item.percentageText}}</text>
            </view>
          </block>
        </view>
      </view>
    </view>

    <view class="card highlights-card">
      <view class="card-header">
        <text class="card-title">智能洞察</text>
        <text class="card-subtitle">Insights</text>
      </view>
      <view class="insight-list">
        <view class="insight-item">
          <view class="insight-icon positive">
            <image class="insight-icon-img" src="/assets/icons/trophy-line.svg" mode="aspectFit"></image>
          </view>
          <view class="insight-label">最高收益分类</view>
          <view class="insight-value">
            <text class="insight-name">{{highlights.bestCategory}}</text>
            <text class="insight-amount positive">{{highlights.bestCategoryAmount}}</text>
          </view>
        </view>
        <view class="insight-item">
          <view class="insight-icon negative">
            <image class="insight-icon-img" src="/assets/icons/information-line-red.svg" mode="aspectFit"></image>
          </view>
          <view class="insight-label">需注意负债</view>
          <view class="insight-value">
            <text class="insight-name">{{highlights.riskCategory}}</text>
            <text class="insight-amount negative">{{highlights.riskCategoryAmount}}</text>
          </view>
        </view>
      </view>
    </view>
  </scroll-view>
</view>
<!--pages/analytics/index.wxml-->
