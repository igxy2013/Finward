<navbar title="收支管理" showBack="{{false}}"></navbar>
<view class="page" bindtouchstart="handleSwipeStart" bindtouchmove="handleSwipeMove" bindtouchend="handleSwipeEnd" bindtouchcancel="handleSwipeCancel">
  <view wx:if="{{swipeLock}}" class="swipe-mask" catchtouchmove="handleMaskMove" bindtouchend="handleSwipeEnd" bindtouchcancel="handleSwipeCancel"></view>
  <view class="toolbar">
    <view class="segmented">
      <view class="seg-item {{activeRange === item.value ? 'active' : ''}}" wx:for="{{rangeTabs}}" wx:key="value" data-value="{{item.value}}" bindtap="handleRangeTab">{{item.label}}</view>
    </view>
    <view class="period" wx:if="{{activeRange === 'month'}}">
      <view class="nav-btn" bindtap="prevMonth">‹</view>
      <picker mode="multiSelector" range="{{monthSelectorRange}}" value="{{monthSelectorIndex}}" bindchange="handlePeriodMultiChange">
        <view class="period-display">{{selectedYear}}年{{selectedMonth}}月</view>
      </picker>
      <view class="nav-btn" bindtap="nextMonth">›</view>
    </view>
    <view class="period" wx:elif="{{activeRange === 'year'}}">
      <view class="nav-btn" bindtap="prevYear">‹</view>
      <picker mode="selector" range="{{yearSelectorRange}}" value="{{yearSelectorIndex}}" bindchange="handleYearSelectorChange">
        <view class="period-display">{{selectedYear}}年</view>
      </picker>
      <view class="nav-btn" bindtap="nextYear">›</view>
    </view>
    <view class="period" wx:elif="{{activeRange === 'all'}}">
      <view class="period-display">全部</view>
    </view>
  </view>

  <view class="summary">
    <view class="summary-item accent-expense" bindtap="applyExpenseFilter">
      <view class="card-bg"></view>
      <view class="card-glow"></view>
      <view class="summary-top">
        <view class="summary-icon">
          <image class="summary-icon-img" src="/assets/icons/bill-line-red.svg" mode="aspectFit"></image>
        </view>
        <text class="sum-label">{{rangeLabelPrefix}}固定支出</text>
      </view>
      <view class="sum-value">
        <text class="currency">￥</text>
        <text class="amount negative">{{summary.expectedExpense}}</text>
      </view>
    </view>
    <view class="summary-item accent-income" bindtap="applyIncomeFilter">
      <view class="card-bg"></view>
      <view class="card-glow"></view>
      <view class="summary-top">
        <view class="summary-icon">
          <image class="summary-icon-img" src="/assets/icons/line-chart-line.svg" mode="aspectFit"></image>
        </view>
        <text class="sum-label">{{rangeLabelPrefix}}预计收入</text>
      </view>
      <view class="sum-value">
        <text class="currency">￥</text>
        <text class="amount positive">{{summary.expectedIncome}}</text>
      </view>
    </view>
    <view class="summary-item accent-expense">
      <view class="card-bg"></view>
      <view class="card-glow"></view>
      <view class="summary-top">
        <view class="summary-icon">
          <image class="summary-icon-img" src="/assets/icons/arrow-up-line.svg" mode="aspectFit"></image>
        </view>
        <text class="sum-label">{{rangeLabelPrefix}}预计净收入</text>
      </view>
      <view class="sum-value">
        <text class="currency">￥</text>
        <text class="amount {{summary.netIncomePositive ? 'positive' : 'negative'}}">{{summary.netIncome}}</text>
      </view>
    </view>
    <view class="summary-item accent-income">
      <view class="card-bg"></view>
      <view class="card-glow"></view>
      <view class="summary-top">
        <view class="summary-icon">
          <image class="summary-icon-img" src="/assets/icons/scales-line.svg" mode="aspectFit"></image>
        </view>
        <text class="sum-label">{{rangeLabelPrefix}}预计收支比</text>
      </view>
      <view class="sum-value">
        <text class="amount positive">{{summary.incomeExpenseRatio}}</text>
      </view>
    </view>
  </view>

  <view class="fab" bindtap="goToCashflowManage">
    <text class="fab-icon">+</text>
  </view>

  <view class="list">
    <view class="list-header">
      <text class="list-title">{{listTitle}}</text>
      <view class="list-filters">
        <view class="pill {{recordFilter === item.value ? 'active' : ''}}" wx:for="{{recordFilterTabs}}" wx:key="value" data-value="{{item.value}}" bindtap="handleRecordFilterTab">{{item.label}}</view>
        <view style="width:1px;height:24rpx;background:rgba(0,0,0,0.1);margin:0 12rpx;"></view>
        <view class="pill {{activeType === item.value ? 'active' : ''}}" wx:for="{{typeTabs}}" wx:key="value" data-value="{{item.value}}" bindtap="handleTypeTab">{{item.label}}</view>
      </view>
    </view>
    <view class="list-container">
      <view class="list-item" wx:for="{{cashflows}}" wx:key="id" data-id="{{item.id}}" bindtap="viewCashflow" bindlongpress="openCashflowActions">
        <view class="item-left">
          <view class="item-icon {{item.type === 'income' ? 'income-icon' : 'expense-icon'}}">
            <image class="item-icon-img" src="/assets/icons/{{item.icon}}" mode="aspectFit"></image>
          </view>
        </view>
        <view class="item-main">
          <view class="item-top">
            <text class="item-name">{{item.name || item.category}}</text>
            <text class="item-amount {{item.type === 'income' ? 'positive' : 'negative'}}">{{item.type === 'income' ? '+' : '-'}}￥{{item.amount}}</text>
          </view>
          <view class="item-meta">
            <text>{{item.date}}</text>
            <text>{{item.planned ? '预计' : '实际'}}</text>
            <text>{{item.recurring_monthly ? '每月重复' : ''}}</text>
            <text wx:if="{{item.account_name}}">{{item.account_name}}</text>
          </view>
          <view class="item-note" wx:if="{{item.recurring_start_date}}">
            <text class="note-text">开始 {{item.recurring_start_date}}</text>
          </view>
          <view class="item-note" wx:if="{{item.end_date}}">
            <text class="note-text">结束 {{item.end_date}}</text>
          </view>
          <view class="item-note" wx:elif="{{item.recurring_end_date}}">
            <text class="note-text">结束 {{item.recurring_end_date}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
