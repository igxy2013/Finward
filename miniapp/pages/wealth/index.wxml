<navbar title="收支管理" showBack="{{false}}"></navbar>
<view class="page">
  <view class="header-area">
    <view class="page-switcher-container">
      <view class="page-switcher">
        <view class="seg-item {{activePage === 'budget' ? 'active' : ''}}" data-value="budget" bindtap="handlePageSwitch">
          <image class="seg-icon" src="/assets/icons/calendar-line.svg" mode="aspectFit" />
          <text class="seg-label">预算</text>
        </view>
        <view class="seg-item {{activePage === 'final' ? 'active' : ''}}" data-value="final" bindtap="handlePageSwitch">
          <image class="seg-icon" src="/assets/icons/calendar-check-line.svg" mode="aspectFit" />
          <text class="seg-label">决算</text>
        </view>
        <view class="seg-underline {{activePage === 'budget' ? 'left' : 'right'}}"></view>
      </view>
    </view>
    <!-- Date Navigation -->
    <view class="date-nav">
      <view class="range-tabs">
        <view class="range-tab {{activeRange === 'month' ? 'active' : ''}}" data-value="month" bindtap="handleRangeTab">月</view>
        <view class="range-tab {{activeRange === 'year' ? 'active' : ''}}" data-value="year" bindtap="handleRangeTab">年</view>
        <view class="range-tab {{activeRange === 'all' ? 'active' : ''}}" data-value="all" bindtap="handleRangeTab">全</view>
      </view>

      <view class="date-picker-row" wx:if="{{activeRange === 'month'}}">
        <view class="nav-arrow" bindtap="prevMonth">
          <image class="nav-arrow-img" src="/assets/icons/arrow-left-s-line.svg" mode="aspectFit" />
        </view>
        <picker mode="multiSelector" 
                range="{{monthSelectorRange}}" 
                value="{{monthSelectorIndex}}" 
                bindchange="handlePeriodMultiChange">
          <view class="current-date">
            <text class="date-text">{{selectedYear}}年{{selectedMonth}}月</text>
            <image class="dropdown-icon" src="/assets/icons/arrow-down-s-fill.svg" mode="aspectFit" />
          </view>
        </picker>
        <view class="nav-arrow" bindtap="nextMonth">
          <image class="nav-arrow-img" src="/assets/icons/arrow-right-s-line.svg" mode="aspectFit" />
        </view>
      </view>
      <view class="date-picker-row" wx:elif="{{activeRange === 'year'}}">
        <view class="nav-arrow" bindtap="prevYear">
          <image class="nav-arrow-img" src="/assets/icons/arrow-left-s-line.svg" mode="aspectFit" />
        </view>
        <picker mode="selector" 
                range="{{yearSelectorRange}}" 
                value="{{yearSelectorIndex}}" 
                bindchange="handleYearSelectorChange">
          <view class="current-date">
            <text class="date-text">{{selectedYear}}年</text>
            <image class="dropdown-icon" src="/assets/icons/arrow-down-s-fill.svg" mode="aspectFit" />
          </view>
        </picker>
        <view class="nav-arrow" bindtap="nextYear">
          <image class="nav-arrow-img" src="/assets/icons/arrow-right-s-line.svg" mode="aspectFit" />
        </view>
      </view>
      <view class="date-picker-row" wx:else>
        <view class="current-date">
          <text class="date-text">全部记录</text>
        </view>
      </view>
    </view>

    <!-- Main Summary Card -->
    <view class="main-card">
      <view class="net-income-section">
        <view class="label-row">
          <text class="label">{{activePage === 'final' ? '实际结余' : '预计结余'}}</text>
          <view class="ratio-badge" wx:if="{{activePage !== 'final' && summary.incomeExpenseRatio !== '—'}}">收支比 {{summary.incomeExpenseRatio}}</view>
        </view>
        <view class="amount-large {{(activePage === 'final' ? summary.netActualPositive : summary.netIncomePositive) ? 'positive' : 'negative'}}">
          <text class="symbol">￥</text>{{activePage === 'final' ? summary.netActualIncome : summary.netIncome}}
        </view>
      </view>
      
      <view class="divider"></view>
      
      <view class="stats-row">
        <view class="stat-item income-item {{activeType === 'income' ? 'active' : ''}}" bindtap="applyIncomeFilter">
        <view class="stat-icon-circle income-bg">
          <image class="stat-icon-img" src="/assets/icons/arrow-up-line.svg" />
        </view>
        <view class="stat-text">
          <text class="stat-label">收入</text>
          <text class="stat-amount income-color">{{activePage === 'final' ? summary.actualIncome : summary.expectedIncome}}</text>
        </view>
      </view>
      <view class="stat-item expense-item {{activeType === 'expense' ? 'active' : ''}}" bindtap="applyExpenseFilter">
        <view class="stat-icon-circle expense-bg">
          <image class="stat-icon-img" src="/assets/icons/arrow-down-line-red.svg" />
        </view>
          <view class="stat-text">
            <text class="stat-label">支出</text>
            <text class="stat-amount expense-color">{{activePage === 'final' ? summary.actualExpense : summary.expectedExpense}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <view class="fab" bindtap="goToCashflowManage">
    <text class="fab-icon">+</text>
  </view>

  <view class="list">
    <view class="list-header">
      <text class="list-title">{{listTitle}}</text>
      <view class="list-filters">
        <view class="pill {{activeType === item.value ? 'active' : ''}}" wx:for="{{typeTabs}}" wx:key="value" data-value="{{item.value}}" bindtap="handleTypeTab">{{item.label}}</view>
      </view>
    </view>
    <view class="list-container">
      <view class="list-item" wx:for="{{cashflows}}" wx:key="id" data-id="{{item.id}}" bindtap="viewCashflow" bindlongpress="openCashflowActions">
        <view class="item-left">
          <view class="item-icon {{item.type === 'income' ? 'income-icon' : 'expense-icon'}}">
            <image class="item-icon-img" src="/assets/icons/{{item.icon}}" mode="aspectFit"></image>
          </view>
        </view>
        <view class="item-main">
          <view class="item-top">
            <text class="item-name">{{item.name || item.category}}</text>
            <text class="item-amount {{item.type === 'income' ? 'positive' : 'negative'}}">{{item.type === 'income' ? '+' : '-'}}￥{{item.amount}}</text>
          </view>
          <view class="item-meta">
            <text>{{item.date}}</text>
            <text>{{item.planned ? '预计' : '实际'}}</text>
            <text>{{item.recurring_monthly ? '每月重复' : ''}}</text>
          </view>
          <view class="item-note" wx:if="{{item.recurring_start_date}}">
            <text class="note-text">开始 {{item.recurring_start_date}}</text>
          </view>
          <view class="item-note" wx:if="{{item.end_date}}">
            <text class="note-text">结束 {{item.end_date}}</text>
          </view>
          <view class="item-note" wx:elif="{{item.recurring_end_date}}">
            <text class="note-text">结束 {{item.recurring_end_date}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
